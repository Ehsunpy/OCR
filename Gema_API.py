from openai import OpenAI
import markdownify
def refine_and_mark():
    '''
    شما ورودی تکست خام میدهدی و مدل زبانی اصلاحات لازم رو انجام خواهد داد
    :param ocr_text:
    :return:MarkDown
    '''
    client = OpenAI(
      base_url="https://openrouter.ai/api/v1",
      api_key="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",
    )
    # برای مثال یک متن که تبدیل شده
    ocr_text = """
     '--- Page 1 ---\n\n\n| ۳.شماره بخشنامه: 1100 CIR  | ۴.تاریخ صدور:۹۶/۲/۱۹  | ۵.پیوست وضمائم: آئین نامه اقامه نماز شماره ۰۱,۱۲,۱۳۷۵-۵۱۸۶۷۰ ت ۵۱۷۳۲۳-۳۰,۰۱,۱۳۷۵-۳۶۷  |\n| ۶.بخش پاسخگو: شورای فرهنگی سازمان  | ۷. تاریخ اجرا: ۹۶/۲/۱۹  | ۸.قوانین مرجع مرتبط: آئین نامه ترویج و توسعه فرهنگ اقامه نماز  |\n| ۹. وضعیت بخشنامه های متاثر:  | ۱۰. شماره بخشنامه\u200cهای متاثر:  |   |\n\n| ۱.موضوع بخشنامه: اقامه نماز در پروازها  |\n| ۲.دفتر صادر کننده: شورای فرهنگی سازمان  |\n| ۱۱. مقدمه و تاریخچه:  |\n| به منظور گسترش فرهنگ اقامه نماز جهت مسافرین بخشنامه نامه ذیل صادر شده است.  |\n| ۱۲. هدف:  |\n| اشاعه فرهنگ نماز  |\n| ۱۳. فهرست گیرندگان: کلیه شرکت\u200cهای هواپیمایی  |\n| ۱۴. مفاد بخشنامه:  |\n| به منظور رعایت اوقات شرعی اقامه نماز مسافرین و احترام به شعائر اسلامی، موارد زیر جهت اجرا ابلاغ می\u200cشود:  |\n\n۱- تمامی مسافران هواپیماهای ایرانی از تمام مبادی و مقاصد و مسافران خطوط هوایی خارجی که از مبادی ایران و یا به مقاصد درون ایران پرواز\nمی\u200cکنند، دارای حق اقامه نمازهای یومیه در شرایط شایسته برخوردار بوده و این حق باید به رسمیت شناخته شده و مورد احترام قرار گیرد.\n۲- در صورتی که در زمان انجام یک پرواز، وقت شرعی نماز آغاز و در همان پرواز پایان یابد، خطوط هوایی موظف به رعایت موارد زیر خواهندبود: \\\nالف) اطلاعات مورد تقاضای مسافران شامل زمان شرعی و جهت قبله را در اختیار مسافران متقاضی قرار دهند.\nب) در صورت امکان، مکانی مناسب و ایمن جهت اقامه فریضه نماز به مسافران معرفی نمایند.\n\nتبصره: در مواردی که وقت اقامه نماز پس از فرود هواپیما منقضی می\u200cشود لیکن فرصت کافی جهت انجام تشریفات ورود به مقصد و اقامه نماز\nوجود ندارد، رعایت مفاد فوق ضروری است.\n\n۳- در صورتی که وقت اقامه نماز، قبل از آغاز برنامه سوار کردن مسافران شروع شود و یا فرصت زمانی اقامه نماز و طول پرواز به گونه\u200cای باشد که \\\nاقامه نماز در زمان پرواز امکان\u200cپذیر نباشد، سوار نمودن مسافران حداقل ۱۵ دقیقه بعد از ورود به وقت نماز آغاز شود و یا برنامه پرواز به گونه\u200cای ]\nتغییر یابد که امکان اقامه نماز پس از فرود و انجام تشریفات ورود به مقصد برای مسافران مهیا شود.\n\n۴- در مواردی که رعایت موارد فوق منجر به نقض الزامات ایمنی و به خطر افتادن جان مسافران شود، رعایت الزامات ایمنی ضروری بوده و \\\nمحدودیت موجود با رعایت احترام و حقوق مسافران به آنها اعلام شده و در خصوص راهکارهای جایگزین، حداکثر همکاری ممکن با مسافران]\nبه عمل\u200cآید.\n\n۵- شرکت\u200cهای هواپیمائی موظف هستند دستورالعمل\u200cها و فرآیندهای مرتبط با برنامه\u200cریزی و مدیریت پرواز را به گونه\u200cای اصلاح و بازنگری نمایندکه]\nمفاد این ابلاغیه در عملیات جاری شرکت\u200cها رعایت گردد.']

    """

    completion = client.chat.completions.create(
      model="google/gemma-3-27b-it:free",
      messages=[
        {
          "role": "user",
          "content": [
            {
              "type": "text",
              "text": f"""تو یک ویرایشگر متن هوشمند هستی. من یک متن خام از OCR بهت می‌دهم. وظایف تو:  
    
    1. اصلاح غلط‌های املایی و نگارشی.  
    2. حفظ کامل قالب Markdown (هر چیزی که به صورت لیست، تیتر، کد یا نقل‌قول آمده باید درست و تمیز بماند).  
    3. بازسازی جاهایی که کاراکترها خراب شده یا به‌هم‌ریخته هستند، به‌گونه‌ای که متن روان و قابل فهم شود.  
    4. خروجی فقط به صورت Markdown بده، بدون هیچ توضیح اضافه.  
    5. متن را در قالب **Markdown منطقی و خوانا** بازنویسی کن.
    
    اینجا متن خام OCR است:  
    {ocr_text}
    """
            }
          ]
        }
      ]
    )

    print(completion.choices[0].message.content)
    markdown_string = markdownify.markdownify(completion.choices[0].message.content, heading_style='ATX')
    return markdown_string
    # 3
markdown_string = refine_and_mark()
with open('sample.md', 'w',encoding="utf-8") as f:
    f.write(markdown_string)